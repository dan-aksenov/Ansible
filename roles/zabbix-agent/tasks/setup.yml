---
- name: Enable zabbix yum repository.
  yum_repository:
    name: zabbix
    description: Zabbix Official Repository - $basearch
    baseurl: http://repo.zabbix.com/zabbix/{{ zabbix_version }}/rhel/{{ ansible_distribution_major_version }}/$basearch/
    gpgkey: https://repo.zabbix.com/RPM-GPG-KEY-ZABBIX-A14FE591
    gpgcheck: true
    enabled: true
  when: ansible_pkg_mgr == 'yum'

- name: Yum install zabbix-agent
  yum:
    state: present
    name:
      - zabbix-agent
      - zabbix-get
      - zabbix-sender
  when: ansible_pkg_mgr == 'yum'

- name: Edit agent.conf file. Add Zabbix server name
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.conf
    regexp: '^Server=.*'
    line: "Server={{ zabbix_server }}"
  notify: restart agent

- name: Edit agent.conf file. Add agents hostname
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.conf
    regexp: '^Hostname=.*'
    line: "Hostname={{ ansible_hostname }}"
  notify: restart agent

- name: start and enable agent
  service:
    name: zabbix-agent
    state: started
    enabled: true

- name: Add firewall exception. Ignore on errorsi(ie if firewall is disabled)
  firewalld:
    port: 10050/tcp
    permanent: true
    state: enabled
    immediate: true
  ignore_errors: true
